<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jeevan Care</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    .header { background-color: #0b1585; }
    .transcript-container { display: flex; justify-content: space-between; margin: 20px; align-items: stretch; }
    .transcript, .legend { width: 48%; background-color: white; padding: 15px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .diagnosis-box, .precautions-box, .clinic-box { background-color: #f7f7f7; border: 1px solid #ddd; padding: 15px; margin: 20px auto; border-radius: 8px; width: 70%; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    button { padding: 10px 15px; margin: 5px; }
    #language-select { padding: 8px 12px; font-size: 14px; font-weight: 500; border-radius: 6px; border: 1px solid #ccc; background-color: #fff; cursor: pointer; transition: border 0.2s ease-in-out; outline: none; }
    #language-select:hover, #language-select:focus { border-color: #2980b9; }
    .instructions { margin-top: 15px; font-size: 14px; color: #555; border-top: 1px solid #ccc; padding-top: 10px; }
    .instructions h4 { margin: 0 0 8px 0; }
    .instructions ul { padding-left: 20px; }
    .instructions li { margin-bottom: 5px; }
    .uncertain { border-bottom: 1px dotted red; cursor: pointer; }
    .suggestion-box { position: fixed; top: 20%; left: 50%; transform: translateX(-50%); background: #fff; border: 1px solid #ccc; padding: 10px; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
  </style>
</head>
<body>
  <div class="header">
    <h1 style="color: white;">Jeevan Care</h1>
  </div>
  <div class="container">
    <div class="controls" style="display: flex; align-items: center; justify-content: center; gap: 15px;">
      <button id="toggle-btn" class="mic-off">üé§ Start Recording</button>
      <div class="language-select">
        <label for="language-select">Select Language: </label>
        <select id="language-select">
          <option value="english" selected>English</option>
          <option value="hindi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
          <option value="generic">Generic</option>
        </select>
      </div>
      <button id="generate-report-btn" class="report-button" style="display: none;">üìÑ Generate Report</button>
    </div>
    
    <div class="transcript-container">
      <div class="transcript">
        <h2>Real-Time Transcript</h2>
        <pre id="transcript-text"></pre>
      </div>
      <div class="legend">
        <h3>Highlights</h3>
        <p><span class="anatomy">Anatomy</span></p>
        <p><span class="medical-history">Medical History</span></p>
        <p><span class="medication">Medication</span></p>
        <p><span class="phi">Protected Health Information</span></p>
        <p><span class="tests">Tests & Treatments</span></p>
        <p><span style="color: blue;">Predicted Diagnosis</span></p>
        <div class="instructions">
          <h4>Instructions</h4>
          <ul>
            <li>Press "Start Recording" to begin transcription.</li>
            <li>Review the transcript and highlighted words.</li>
            <li>Click an underlined (uncertain) word to see suggestions.</li>
            <li>Select a suggestion to update the transcript and reanalyze.</li>
          </ul>
        </div>
      </div>
    </div>
    
    <div class="diagnosis-box">
      <h2>Predicted Diagnosis</h2>
      <div id="diagnosis-box"></div>
    </div>
    <div class="precautions-box">
      <h2>Precautions & Home Remedies</h2>
      <div id="precautions-box"></div>
    </div>
    <div class="clinic-box">
      <h2>Nearby Clinics and Hospitals</h2>
      <div id="clinic-suggestions"></div>
    </div>
  </div>
  
  <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
  <script>
    const socket = io();
    const toggleBtn = document.getElementById('toggle-btn');
    const reportBtn = document.getElementById('generate-report-btn');
    const transcriptText = document.getElementById('transcript-text');
    const diagnosisBox = document.getElementById('diagnosis-box');
    const precautionsBox = document.getElementById('precautions-box');
    const clinicBox = document.getElementById('clinic-suggestions');
    const languageSelect = document.getElementById('language-select');
    let isRecording = false;
    let analyzedText = '';

    // Helper: Wrap known mis-transcriptions as uncertain.
    function markUncertainWords(text) {
      const uncertainWords = ["cuff", "feevr"];
      uncertainWords.forEach(word => {
        const regex = new RegExp(`\\b(${word})\\b(?!</span>)`, 'gi');
        text = text.replace(regex, `<span class="uncertain">$1</span>`);
      });
      return text;
    }

    toggleBtn.addEventListener('click', () => {
      isRecording = !isRecording;
      if (isRecording) {
        toggleBtn.textContent = "üõë Stop Recording";
        toggleBtn.classList.remove('mic-off');
        toggleBtn.classList.add('mic-on');
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition((position) => {
            let location = {
              latitude: position.coords.latitude,
              longitude: position.coords.longitude
            };
            socket.emit('toggle_transcription', { language: languageSelect.value, location: location });
          }, (error) => {
            console.error("Error getting location:", error);
            socket.emit('toggle_transcription', { language: languageSelect.value });
          });
        } else {
          socket.emit('toggle_transcription', { language: languageSelect.value });
        }
      } else {
        toggleBtn.textContent = "üé§ Start Recording";
        toggleBtn.classList.remove('mic-on');
        toggleBtn.classList.add('mic-off');
        socket.emit('toggle_transcription', { language: languageSelect.value });
      }
    });

    socket.on('partial_transcript', data => {
      let updatedText = analyzedText + data.text;
      updatedText = markUncertainWords(updatedText);
      transcriptText.innerHTML = updatedText;
    });

    socket.on('formatted_transcript', data => {
      analyzedText = data.text + "<br>";
      let updatedText = markUncertainWords(analyzedText);
      transcriptText.innerHTML = updatedText;
      const diagnosisRegex = /<span\s+style="color:\s*blue;">(.*?)<\/span>/i;
      const match = diagnosisRegex.exec(data.text);
      if(match) {
        diagnosisBox.innerHTML = match[1] + "<br>";
      }
      reportBtn.style.display = 'inline-block';
    });

    socket.on('precautions', data => { precautionsBox.innerHTML = data.text; });
    socket.on('clinic_suggestions', data => { clinicBox.innerHTML = data.text; });
    reportBtn.addEventListener('click', () => { window.location.href = '/report'; });
    
    // When an uncertain word is clicked, request correction suggestions.
    document.addEventListener('click', function(e) {
      if (e.target && e.target.classList.contains('uncertain')) {
        const unclearWord = e.target.textContent;
        const context = transcriptText.textContent;
        socket.emit('suggest_correction', { word: unclearWord, context: context });
        e.target.style.borderBottom = '2px dashed blue';
      }
    });

    // When suggestions are received, show a suggestion box.
    socket.on('correction_suggestions', data => {
      const { word, suggestions } = data;
      const suggestionBox = document.createElement('div');
      suggestionBox.className = 'suggestion-box';
      suggestionBox.innerHTML = `<p>Did you mean:</p>`;
      
      suggestions.forEach(suggestion => {
        const btn = document.createElement('button');
        btn.textContent = suggestion;
        btn.style.margin = '5px';
        btn.onclick = function() {
          // Use DOM methods to replace all uncertain elements matching the word.
          const uncertainElements = transcriptText.querySelectorAll('.uncertain');
          uncertainElements.forEach(elem => {
            if (elem.textContent.trim().toLowerCase() === word.toLowerCase()) {
              elem.outerHTML = suggestion;
            }
          });
          suggestionBox.remove();
          // Extract plain text (without HTML) for re-analysis.
          const plainText = transcriptText.textContent;
          socket.emit('re_analyze_transcript', { updated_transcript: plainText });
        };
        suggestionBox.appendChild(btn);
      });
      document.body.appendChild(suggestionBox);
    });
  </script>
</body>
</html>
